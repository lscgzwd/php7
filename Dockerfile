# 这里是注释
# 设置继承自哪个镜像
FROM centos:6.9
# 下面是一些创建者的基本信息
MAINTAINER lscgzwd (lscgzwd@gmail.com)
CMD /run.sh
RUN export PATH=$PATH:/bin:/usr/bin:/usr/local/bin&& rpm -ivh https://mirrors.ustc.edu.cn/epel/6/x86_64/epel-release-6-8.noarch.rpm && yum install -y zip unzip libzip2 libzip-devel bzip2-devel xz xz-devel gcc gcc-c++ make cmake autoconf patch pkgconfig gettext automake bison binutils libtool patchutils gcc-gfortran ctags intltool byacc subversion swig flex wget file openldap-devel readline-devel libzip-devel openjpeg2-devel openssl-devel openssh-server libxml2-devel zlib-devel libcurl-devel libmcrypt-devel libpng-devel libXpm-devel libwebp-devel bison* re2c openjpeg-devel libjpeg-turbo-devel bzip2-devel freetype-devel ImageMagick-devel  ghostscript-devel xorg-x11 xorg-x11-fonts xorg-x11-fonts-type1 xorg-x11-fonts-Type1 xorg-x11-fonts-75dpi icu libicu-devel xorg-x11-server-devel fontconfig-devel qtwebkit xorg-x11-server-Xvfb libXext-devel libX11-devel freetype-devel xorg-x11-devel git libXrender-devel libjpeg-devel libpng-devel pcre2-devel gd-devel && cp -frp /usr/lib64/libldap* /usr/lib  && /bin/cp -frp /usr/lib64/libldap* /usr/lib && cd /tmp && wget -O php-7.0.24.tar.gz http://cn2.php.net/distributions/php-7.0.24.tar.gz && tar xf php-7.0.24.tar.gz && cd php-7.0.24 && ./configure --prefix=/data/php7 --enable-fpm --with-fpm-user=nginx --with-fpm-group=nginx --disable-ipv6 --with-openssl --with-libxml-dir --with-zlib --enable-bcmath --with-bz2 --with-curl --with-webp-dir --with-jpeg-dir --with-png-dir --with-xpm-dir --enable-gd-native-ttf --enable-mbstring --with-ldap --with-ldap-sasl --with-mcrypt --enable-pcntl --with-pdo-mysql --enable-shmop --enable-sockets --with-readline --enable-zip --enable-mysqlnd --with-mysqli --with-gd --with-freetype-dir&& sed -i 's/-lcrypto/-lcrypto -llber/g' ./Makefile && make && make install&&rm -rf /data/php7/etc/php-fpm.confr && rm -rf /data/php7/etc/php-fpm.d/www.conf && rm -rf /data/php7/etc/php-fpm.d/nginx.confr && mv /data/php7/etc/php-fpm.d/www.conf.default /data/php7/etc/php-fpm.d/nginx.conf && sed -ir 's/\[www\]/\[nginx\]/g' /data/php7/etc/php-fpm.d/nginx.conf && mv /data/php7/etc/php-fpm.conf.default /data/php7/etc/php-fpm.conf && sed -ir 's/;error_log\s*=.*/error_log=\/data\/logs\/php7\/php_fpm\.log/g' /data/php7/etc/php-fpm.conf&&sed -ir 's/;catch_workers_output/catch_workers_output/g' /data/php7/etc/php-fpm.d/nginx.conf && cp ./php.ini-development /data/php7/lib/php.ini&&sed -ir 's/;date\.timezone\s*\=/date\.timezone=PRC/g' /data/php7/lib/php.ini&&sed -ir 's/;error_log\s*=.*/error_log=\/data\/logs\/php7\/php_error\.log/g' /data/php7/lib/php.ini&& cd .. && rm -rf php-7.0.24*&&yes|/data/php7/bin/pecl install -fsa igbinary &&yes|/data/php7/bin/pecl install -fsa redis &&yes|/data/php7/bin/pecl install -fsa swoole &&yes|/data/php7/bin/pecl install -fsa yaf &&yes|/data/php7/bin/pecl install -fsa imagick &&cd /tmp && wget -O zookeeper-3.4.10.tar.gz http://mirror.bit.edu.cn/apache/zookeeper/stable/zookeeper-3.4.10.tar.gz && tar xvf zookeeper-3.4.10.tar.gz && cd zookeeper-3.4.10/src/c && ./configure --prefix=/data/zookeeper && make && make install && cd /tmp&&rm -rf zookeeper-3.4.10*&& cd /tmp && wget http://pecl.php.net/get/zookeeper-0.4.0.tgz && tar xvf zookeeper-0.4.0.tgz && cd zookeeper-0.4.0 && /data/php7/bin/phpize && ./configure --with-php-config=/data/php7/bin/php-config --with-libzookeeper-dir=/data/zookeeper &&make && make install  &&  echo -e "extension=igbinary.so\nextension=redis.so\nextension=yaf.so\nextension=imagick.so\nextension=swoole.so\nzend_extension=opcache.so\nextension=zookeeper.so\n" >> /data/php7/lib/php.ini && yum install -y redis && chkconfig sshd on && chkconfig redis off && rm -rf /tmp/*&&rm -rf /var/log/* && chown -R nginx:nginx /data && cd ~ && git clone --recursive https://github.com/wkhtmltopdf/wkhtmltopdf.git && cd wkhtmltopdf && ./scripts/build.py posix-local && /bin/cp -rf static-build/posix-local/wkhtmltox-0.12.5*/* /usr/local/ && cd /tmp && rm -rf ~/wkhtmltopdf && mkdir -p /usr/share/fonts && cd /usr/share/fonts && wget -O fonts.zip https://storage-qiye.jiedaibao.com/v1/qiye/fonts.zip && unzip fonts.zip && rm -rf fonts.zip && cd /tmp && wget https://nodejs.org/dist/v8.7.0/node-v8.7.0-linux-x64.tar.xz && tar xvf node-v8.7.0-linux-x64.tar.xz && cp -rf node-v8.7.0-linux-x64/* /usr/local/ && rm -rf node-v8.7.0-linux-x64*&&echo -e "#!/bin/bash\nset -x\n# start ssh service\n/etc/init.d/sshd start\nif [ -f "/deploy/$APPID/deploy.sh" ]; then\n    sh /deploy/$APPID/deploy.sh\nfi\ntail -f /dev/null\n" >> /run.sh && chmod +x /run.sh&&mkdir -p /data/logs/php7 && mkdir /data/conf&& cd /tmp && wget http://nginx.org/download/nginx-1.12.2.tar.gz && tar xzvf nginx-1.12.2.tar.gz && cd nginx-1.12.2 && mkdir -p /data/nginx/modules && wget https://ftp.pcre.org/pub/pcre/pcre-8.41.tar.gz && tar -xzvf pcre-8.41.tar.gz -C /data/nginx/modules && wget https://www.openssl.org/source/openssl-1.0.2l.tar.gz && tar -xzvf openssl-1.0.2l.tar.gz -C /data/nginx/modules && wget http://zlib.net/zlib-1.2.11.tar.gz &&tar -xzvf zlib-1.2.11.tar.gz -C /data/nginx/modules && wget http://luajit.org/download/LuaJIT-2.0.5.tar.gz && tar xzvf LuaJIT-2.0.5.tar.gz &&cd LuaJIT-2.0.5&& make && make install && wget https://github.com/openresty/lua-nginx-module/archive/v0.10.10.tar.gz && tar xzvf v0.10.10.tar.gz -C /data/nginx/modules && cd .. && ./configure --prefix=/data/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_image_filter_module  --with-http_sub_module --with-http_gzip_static_module --with-http_stub_status_module --http-log-path=/data/logs/access.log --with-zlib=/data/nginx/modules/zlib-1.2.11 --with-openssl=/data/nginx/modules/openssl-1.0.2l --with-pcre --error-log-path=/data/logs/error.log --pid-path=/data/nginx/nginx.pid --with-pcre=/data/nginx/modules/pcre-8.41 --add-module=/data/nginx/modules/lua-nginx-module-0.10.10 && make && make install && cd .. &&  rm -rf nginx-1.12.2
